# Deployment with Node Affinity and Scheduling Constraints
apiVersion: apps/v1
kind: Deployment
metadata:
  name: resource-app-scheduled
  labels:
    qos: scheduled
spec:
  replicas: 1
  selector:
    matchLabels:
      app: resource-app
      qos: scheduled
  template:
    metadata:
      labels:
        app: resource-app
        qos: scheduled
    spec:
      # Node Selector - Simple node selection
      # nodeSelector:
      #   disktype: ssd
      
      # Node Affinity - Advanced node selection
      affinity:
        nodeAffinity:
          # Required: Pod will NOT be scheduled if conditions not met
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: Exists  # Any node with hostname
          
          # Preferred: Scheduler will TRY to honor, but not required
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: DoesNotExist  # Prefer worker nodes
        
        # Pod Anti-Affinity - Spread pods across nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - resource-app
                topologyKey: kubernetes.io/hostname
      
      # Tolerations - Allow scheduling on tainted nodes
      # tolerations:
      #   - key: "dedicated"
      #     operator: "Equal"
      #     value: "experimental"
      #     effect: "NoSchedule"
      
      containers:
        - name: resource-app
          image: resource-limits:1.0
          imagePullPolicy: Never
          ports:
            - containerPort: 8080
          
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
