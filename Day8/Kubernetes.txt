ğŸ“‹ Kubernetes Health Probes Explained
======================================

ğŸ”¹ What are Health Probes?
--------------------------
Health probes are Kubernetes mechanisms to check if your application is:
    1. Running (Liveness)
    2. Ready to serve traffic (Readiness)
    3. Done starting up (Startup)

Kubernetes uses these probes to make decisions about:
    âœ… When to restart containers
    âœ… When to send traffic to pods
    âœ… When to wait for slow-starting apps


ğŸ”¹ Types of Health Probes
==========================

1ï¸âƒ£ LIVENESS PROBE
------------------
Question: "Is the application alive?"

Purpose:
    â€¢ Detects if application is in an unrecoverable state
    â€¢ Examples: deadlock, memory leak, infinite loop

Action if fails:
    âŒ Kubernetes RESTARTS the container
    
When to use:
    âœ… Detect crashed applications
    âœ… Detect deadlocked applications
    âœ… Detect unresponsive applications
    
Configuration:
    livenessProbe:
      httpGet:
        path: /actuator/health/liveness
        port: 8080
      initialDelaySeconds: 30    # Wait 30s before first check
      periodSeconds: 10           # Check every 10s
      failureThreshold: 3         # Restart after 3 failures

Example scenarios:
    â€¢ Application enters infinite loop â†’ Liveness fails â†’ Pod restarts
    â€¢ Application deadlocks â†’ Liveness fails â†’ Pod restarts
    â€¢ JVM runs out of memory â†’ Liveness fails â†’ Pod restarts


2ï¸âƒ£ READINESS PROBE
-------------------
Question: "Can the application serve traffic?"

Purpose:
    â€¢ Determines if pod should receive requests from service
    â€¢ Checks if dependencies are available

Action if fails:
    âŒ Kubernetes REMOVES pod from service endpoints
    âœ… Pod stays running, but gets NO traffic

When to use:
    âœ… Check database connectivity
    âœ… Check external API availability
    âœ… Check cache availability
    âœ… Wait for data loading to complete
    
Configuration:
    readinessProbe:
      httpGet:
        path: /actuator/health/readiness
        port: 8080
      initialDelaySeconds: 10    # Wait 10s before first check
      periodSeconds: 5            # Check every 5s
      failureThreshold: 3         # Mark not ready after 3 failures

Example scenarios:
    â€¢ Database connection lost â†’ Readiness fails â†’ No traffic sent
    â€¢ External API timeout â†’ Readiness fails â†’ Traffic goes to healthy pods
    â€¢ Loading large dataset â†’ Readiness fails until done
    â€¢ Application overloaded â†’ Can temporarily fail readiness


3ï¸âƒ£ STARTUP PROBE
-----------------
Question: "Is the application done starting?"

Purpose:
    â€¢ Protects slow-starting containers
    â€¢ Disables liveness/readiness until startup completes

Action if fails:
    âŒ After ALL attempts fail â†’ Kubernetes RESTARTS container
    âœ… While running â†’ Liveness/Readiness checks are DISABLED

When to use:
    âœ… Applications with slow initialization
    âœ… Large data loading on startup
    âœ… Legacy applications that take time to start
    
Configuration:
    startupProbe:
      httpGet:
        path: /actuator/health/liveness
        port: 8080
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 30        # Allow 300s (30 * 10) for startup

Example scenarios:
    â€¢ App needs to load 1GB cache â†’ Startup probe waits
    â€¢ Database schema migration on startup â†’ Startup probe waits
    â€¢ Without startup probe â†’ Liveness kills slow-starting app


ğŸ”¹ Probe Configuration Parameters
==================================

Parameter              | Description                           | Default
-----------------------|---------------------------------------|--------
initialDelaySeconds    | Wait before first probe               | 0
periodSeconds          | How often to probe                    | 10
timeoutSeconds         | Probe timeout                         | 1
successThreshold       | Consecutive successes to pass         | 1
failureThreshold       | Consecutive failures to fail          | 3

Examples:

Fast-checking readiness:
    readinessProbe:
      periodSeconds: 5           # Check every 5 seconds
      timeoutSeconds: 2          # Timeout after 2 seconds
      failureThreshold: 2        # Fail after 2 failures

Slow-starting app:
    startupProbe:
      initialDelaySeconds: 10
      periodSeconds: 10
      failureThreshold: 60       # Allow 600s for startup


ğŸ”¹ Probe Types (How to Check)
==============================

1. HTTP GET
-----------
Most common for web applications

    livenessProbe:
      httpGet:
        path: /health
        port: 8080
        httpHeaders:
          - name: Custom-Header
            value: Awesome

Success: HTTP 200-399
Failure: Any other code or timeout


2. TCP Socket
-------------
Check if port is open (for non-HTTP apps)

    livenessProbe:
      tcpSocket:
        port: 8080

Success: Connection established
Failure: Connection refused


3. Exec Command
---------------
Run command inside container

    livenessProbe:
      exec:
        command:
          - cat
          - /tmp/healthy

Success: Exit code 0
Failure: Non-zero exit code


ğŸ”¹ Spring Boot Actuator Integration
====================================

Enable health probes in application.properties:
    management.endpoint.health.probes.enabled=true
    management.health.livenessState.enabled=true
    management.health.readinessState.enabled=true

Available endpoints:
    /actuator/health              â†’ Overall health
    /actuator/health/liveness     â†’ Liveness state
    /actuator/health/readiness    â†’ Readiness state

Response format:
    {
      "status": "UP",
      "components": {
        "livenessState": {
          "status": "UP"
        },
        "readinessState": {
          "status": "UP"
        },
        "db": {
          "status": "UP",
          "details": {...}
        }
      }
    }


ğŸ”¹ Decision Flow
================

Pod Starts
    â†“
Startup Probe Running?
    YES â†’ Startup checks every periodSeconds
          â†“
          Passes? â†’ Enable Liveness & Readiness
          Fails?  â†’ Keep trying (up to failureThreshold)
                   â†’ All attempts failed? RESTART POD
    â†“
Liveness Probe
    â†“
    Healthy? â†’ Continue running
    Fails?   â†’ RESTART CONTAINER
    â†“
Readiness Probe
    â†“
    Ready?     â†’ Add to Service endpoints (receives traffic)
    Not Ready? â†’ Remove from Service endpoints (no traffic)


ğŸ”¹ Common Patterns
==================

Pattern 1: Web Application with Database
-----------------------------------------
    livenessProbe:
      httpGet:
        path: /actuator/health/liveness
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
    
    readinessProbe:
      httpGet:
        path: /actuator/health/readiness  # Includes DB check
      initialDelaySeconds: 10
      periodSeconds: 5
      failureThreshold: 3

Pattern 2: Slow-Starting Application
-------------------------------------
    startupProbe:
      httpGet:
        path: /health
      periodSeconds: 10
      failureThreshold: 30        # 300s startup time
    
    livenessProbe:
      httpGet:
        path: /health
      periodSeconds: 10
    
    readinessProbe:
      httpGet:
        path: /ready
      periodSeconds: 5

Pattern 3: Microservice with External Dependencies
---------------------------------------------------
    readinessProbe:
      httpGet:
        path: /actuator/health/readiness
      periodSeconds: 5
      failureThreshold: 2         # Fail fast, recover fast
    
    Custom HealthIndicator checks:
      âœ… Database connection
      âœ… External API availability
      âœ… Message queue connection
      âœ… Cache availability


ğŸ”¹ Best Practices
=================

Liveness Probe:
    âœ… DO use for detecting unrecoverable failures
    âœ… DO keep checks simple and fast
    âœ… DO set appropriate initialDelaySeconds
    âŒ DON'T check external dependencies (use readiness)
    âŒ DON'T make it too sensitive
    âŒ DON'T use same endpoint as readiness

Readiness Probe:
    âœ… DO check all critical dependencies
    âœ… DO fail if app can't serve traffic properly
    âœ… DO check frequently (periodSeconds: 5)
    âœ… DO recover automatically when dependencies return
    âŒ DON'T check non-critical dependencies
    âŒ DON'T fail for transient errors (use failureThreshold: 3)

Startup Probe:
    âœ… DO use for slow-starting apps
    âœ… DO set high failureThreshold
    âœ… DO disable if app starts quickly (< 10s)
    âŒ DON'T use for fast-starting apps


ğŸ”¹ Troubleshooting
==================

Pod keeps restarting:
    Cause: Liveness probe failing
    Debug:
      kubectl describe pod <pod-name>
      kubectl logs <pod-name>
      kubectl logs <pod-name> --previous
    Fix:
      â€¢ Increase initialDelaySeconds
      â€¢ Increase failureThreshold
      â€¢ Fix the underlying issue

Pod not receiving traffic:
    Cause: Readiness probe failing
    Debug:
      kubectl get endpoints <service-name>
      kubectl describe pod <pod-name>
      curl http://<pod-ip>:8080/actuator/health
    Fix:
      â€¢ Check dependencies (DB, cache, APIs)
      â€¢ Review custom health indicators
      â€¢ Temporarily disable strict checks

Pod stuck in ContainerCreating:
    Cause: Startup probe failing immediately
    Debug:
      kubectl describe pod <pod-name>
    Fix:
      â€¢ Add or increase initialDelaySeconds
      â€¢ Increase failureThreshold


ğŸ”¹ Verification Commands
========================

Check probe configuration:
    kubectl get pod <pod-name> -o yaml | grep -A 10 Probe

Watch pod status:
    kubectl get pods -w

Describe pod (see probe results):
    kubectl describe pod <pod-name>

Check endpoints (readiness status):
    kubectl get endpoints <service-name>

Test health endpoint directly:
    kubectl exec -it <pod-name> -- curl localhost:8080/actuator/health

Port-forward and test locally:
    kubectl port-forward <pod-name> 8080:8080
    curl http://localhost:8080/actuator/health/liveness
    curl http://localhost:8080/actuator/health/readiness


ğŸ¯ Key Takeaways
================

1. Use ALL THREE probes for production applications
2. Liveness = "Restart me if broken"
3. Readiness = "Stop traffic if not ready"
4. Startup = "Wait for me to finish starting"
5. Spring Boot Actuator makes health checks easy
6. Tune parameters based on your app's behavior
7. Monitor probe failures in production
8. Always test probe configurations before deploying
